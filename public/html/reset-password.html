<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title data-translate-key="resetPasswordTitle">Yeni Şifre Belirle</title>
    <link rel="stylesheet" href="/css/stylegeneral.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>
<body>
    <header>
        <div class="left"><h1 data-translate-key="mainTitle">İstanbul Müzeleri</h1></div>
        <div class="right">
            <div id="language-switcher">
                <button id="lang-tr">TR</button>
                <button id="lang-en">EN</button>
            </div>
        </div>
    </header>

    <div class="auth-container">
        <div class="auth-content"> 
            <h1 data-translate-key="resetPasswordTitle">Yeni Şifre Belirle</h1>
            <form id="resetPasswordForm">
                <input type="password" id="newPassword" data-translate-key="newPasswordPlaceholder" placeholder="Yeni Şifre" required minlength="8">
                <input type="password" id="confirmPassword" data-translate-key="confirmPasswordPlaceholder" placeholder="Yeni Şifre Tekrar" required minlength="8">
                <button type="submit" data-translate-key="updatePasswordBtn">Şifreyi Güncelle</button>
            </form>
            <div id="message" style="margin-top: 15px; text-align: center; font-size: 0.85rem;"></div>
        </div>
    </div>

    <div class="auth-slideshow-full">
        <div id="slideshow-bg-next" class="slide-img" style="opacity: 0;"></div>
        <div id="slideshow-bg" class="slide-img"></div>
        <div class="slide-overlay"></div>
    </div>

    <footer class="auth-footer">
        <p data-translate-key="copyrightNotice">© 2025 Dijital Müzeler. Her Hakkı Saklıdır.</p>
    </footer>

    <script src="/scripts/translations.js"></script>
    <script src="/scripts/language.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const resetForm = document.getElementById('resetPasswordForm');
            const msgDiv = document.getElementById('message');

            if (resetForm) {
                resetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const password = document.getElementById('newPassword').value;
                    const confirm = document.getElementById('confirmPassword').value;

                    if (!token) {
                        msgDiv.innerText = translations[window.currentLang]?.generalError || "Geçersiz link.";
                        return;
                    }

                    if (password !== confirm) {
                        alert(translations[window.currentLang]?.passwordMismatch || "Şifreler eşleşmiyor!");
                        return;
                    }

                    try {
                        const res = await fetch(`/api/reset-password/${token}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(translations[window.currentLang]?.passwordUpdateSuccess || "Şifreniz güncellendi!");
                            window.location.href = "/html/login.html";
                        } else {
                            msgDiv.style.color = "#ff4d4d";
                            msgDiv.innerText = data.message;
                        }
                    } catch (err) {
                        msgDiv.innerText = translations[window.currentLang]?.serverError || "Sunucu hatası.";
                    }
                });
            }
            initSlideshow();
        });

        async function initSlideshow() {
            const currentBg = document.getElementById('slideshow-bg');
            const nextBg = document.getElementById('slideshow-bg-next');
            if (!currentBg || !nextBg) return;
            try {
                const res = await fetch('/api/museum');
                let museums = await res.json();
                if (!museums || museums.length === 0) return;
                museums = [...museums].sort(() => Math.random() - 0.5);
                const getPath = (m) => m.imageUrl || m.image || "";
                let i = 0;
                currentBg.style.backgroundImage = `url('${getPath(museums[i])}')`;
                currentBg.style.opacity = "1";
                setInterval(() => {
                    let nextIndex = (i + 1) % museums.length;
                    const nextImgPath = getPath(museums[nextIndex]);
                    nextBg.style.backgroundImage = `url('${nextImgPath}')`;
                    nextBg.style.opacity = "1";
                    currentBg.style.opacity = "0";
                    setTimeout(() => {
                        currentBg.style.transition = "none"; 
                        currentBg.style.backgroundImage = `url('${nextImgPath}')`;
                        currentBg.style.opacity = "1"; 
                        i = nextIndex;
                        setTimeout(() => { currentBg.style.transition = "opacity 1.5s ease-in-out"; }, 50);
                    }, 1500); 
                }, 5000);
            } catch (e) { console.warn(e); }
        }
    </script>
</body>
</html>